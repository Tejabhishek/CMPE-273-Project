import os
import time
from nltk import ne_chunk, pos_tag, word_tokenize
from nltk.tree import Tree
import unicodedata    
import random
import pymysql
from slackclient import SlackClient
from PyDictionary import PyDictionary
dictionary=PyDictionary()



db = pymysql.connect(host="localhost",
                     user="root",
                     passwd="password12",
                     db="chatbot1")


cur = db.cursor()



# starterbot's ID as an environment variable
BOT_ID = os.environ.get("BOT_ID")

# constants
AT_BOT = "<@" + BOT_ID + ">"
EXAMPLE_COMMAND = "do"

# instantiate Slack & Twilio clients
slack_client = SlackClient(os.environ.get('SLACK_BOT_TOKEN'))

professor= ['professor','assistant','lecturer','tutor']
final1=[]

for i in professor:
 list1=dictionary.synonym(i)
 list1 = [str(i).strip() for i in list1]

 final1.append(list1)
 
 """Greetings info"""
greetings= [ 'hi', 'hi there', 'hey', 'how are you', 'whats up?', 'greetings','good evening', 'goodday', 'hello']

#subject details

office=['location','office']

meeting=['hours', 'meeting']

locationtime=['class timings','lecture hall']

course=['website',' link']
department=['department','division']


def parse_slack_output(slack_rtm_output):
    """
        The Slack Real Time Messaging API is an events firehose.
        this parsing function returns None unless a message is
        directed at the Bot, based on its ID.
    """
    output_list = slack_rtm_output
    if output_list and len(output_list) > 0:
        for output in output_list:
            if output and 'text' in output and AT_BOT in output['text']:
                # return text after the @ mention, whitespace removed
                return output['text'].split(AT_BOT)[1].strip().lower(), \
                       output['channel']
    return None, None


def handle_command(command, channel):

	for i in greetings:
		
		if i==command:
			#print i
			cur.execute("SELECT * FROM solutions where questions like '%hey%'")
			for row in cur.fetchall():
					response = row[1]+':grinning:'
		else:
			response = ""
		slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)
	for i in final1:
		#print i
		for j in i:
			if j in command:
				cur.execute("SELECT * FROM solutions where questions like '%teacher%'")
				for row in cur.fetchall():
					response = row[1]+':closed_book:'
			else:
				response = ""
			slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)
	for i in meeting:
		if i in command:
			#print i
			cur.execute("SELECT * FROM solutions where questions like '%hours%'")
			for row in cur.fetchall():
					response = row[1]+':two_men_holding_hands:'
		else:
			response = ""
		slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)

	for i in locationtime:
		if i in command:
			#print i
			cur.execute("SELECT * FROM solutions where questions like '%class timings%'")
			for row in cur.fetchall():
					response = row[1]
		else:
			response = ""
		slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)

	for i in course:
		if i in command:
			#print i
			cur.execute("SELECT * FROM solutions where questions like '%website%'")
			for row in cur.fetchall():
					response = row[1]
		else:
			response = ""
		slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)
	for i in department:
		if i in command:
			#print i
			cur.execute("SELECT * FROM solutions where questions like '%department%'")
			for row in cur.fetchall():
					response = row[1]
		else:
			response = ""
		slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)
	if 'grading' in command:
	for i in office:
		if i in command:
			#print i
			cur.execute("SELECT * FROM solutions where questions like '%office%'")
			for row in cur.fetchall():
					response = row[1]+':house:'
		else:
			response = ""
		slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)
	if 'course' in command and 'description' in command:
		cur.execute("SELECT * FROM solutions where questions like '%description%'")
		for row in cur.fetchall():
			response = row[1]+':closed_book:'
	else:
		response = ""
	slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)
		

	if 'subject'==command:
		#print i
		cur.execute("SELECT * FROM solutions where questions like '%subject%'")
		for row in cur.fetchall():
			response = row[1]+':closed_book:'
	else:
		response = ""
	slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)

	if 'mail' in command:
		#print i
		cur.execute("SELECT * FROM solutions where questions like '%mail%'")
		for row in cur.fetchall():
			response = row[1]+':scroll:'
	else:
		response = ""
	slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)


		cur.execute("SELECT * FROM solutions where questions like '%grading%'")
		for row in cur.fetchall():
			response = row[1]+':blush:'
	else:
		response = ""
	slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)
	if 'final' in command:
		cur.execute("SELECT * FROM solutions where questions like '%final2%'")
		for row in cur.fetchall():
			response = row[1]+':writing_hand:  :+1:'
	else:
		response = ""
	slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)
	if 'mid' in command:
		cur.execute("SELECT * FROM solutions where questions like '%mid term exam date%'")
		for row in cur.fetchall():
			response = row[1]
	else:
		response = ""
	slack_client.api_call("chat.postMessage", channel=channel,text=response, as_user=True)

if __name__ == "__main__":

    READ_WEBSOCKET_DELAY = 1 # 1 second delay between reading from firehose
    if slack_client.rtm_connect():
        print("StarterBot connected and running!")
        while True:
            command, channel = parse_slack_output(slack_client.rtm_read())
            if command and channel:
                handle_command(command, channel)
            time.sleep(READ_WEBSOCKET_DELAY)
    else:
        print("Connection failed. Invalid Slack token or bot ID?")
